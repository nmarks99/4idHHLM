
# Selected stripe
# 0: Rh
# 1: Si
# 2: Pt
# record(longout, "$(P)stripe")
# {
    # field(DRVL, 0)
    # field(DRVH, 2)
    # field(PINI, 1)
    # field(FLNK, "$(P)stripe_fanout.PROC")
# }

record(mbbo, "$(P)stripe")
{
    # field(DTYP, "Soft Channel")
    field(PINI, 1)
    field(ZRST, "Rh")
    field(ONST, "Si")
    field(TWST, "Pt")
    field(FLNK, "$(P)stripe_fanout.PROC")
}

record(ai, "$(P)Ecritical")
{
    field(DESC, "Ecrit (keV) for selected stripe")
}

record(ai, "$(P)alpha")
{
    field(DESC, "Glancing angle")
}

record(ai, "$(P)beam_offset")
{
    field(DESC, "Beam offset")
}

record(fanout, "$(P)stripe_fanout")
{
    field(LNK0, "$(P)Y_calc")
    field(LNK1, "$(P)Ec_calc")
    field(LNK2, "$(P)alpha_calc")
    field(LNK3, "$(P)beam_offset_calc")
}

record(calcout, "$(P)alpha_calc")
{
    field(INPA, "$(P)$(x1).RBV")
    field(INPB, "$(P)$(x2).RBV")
    field(INPC, "670") # 670mm
    field(CALC, "ATAN((A-B)/C)") # 0 is Rh position
    field(OUT, "$(P)alpha")
}

record(calcout, "$(P)beam_offset_calc")
{
    field(INPA, "$(P)alpha.VAL")
    field(INPB, "670") # 670mm
    field(CALC, "B*SIN(C)+2")
    field(OUT, "$(P)beam_offset")
}

# Sets Y motor position according to selected stripe 
record(calcout, "$(P)Y_calc")
{
    field(INPA, "$(P)stripe.VAL")
    field(INPB, "0") # Rh position
    field(CALC, "(A*11)+B")
    field(OUT, "$(P)$(y).VAL CA")
}

# Sets critical energy $(P)Ecritical according to selected stripe
record(calcout, "$(P)Ec_calc")
{
    field(INPA, "$(P)stripe.VAL")
    field(CALC, "(A == 0) ? 21 : (A == 1) ? 10 : (A == 2) ? 27 : 0")
    field(OUT, "$(P)Ecritical")
}
